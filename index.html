<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مدیریت استیکر هنرجویان</title>
    <style>
        /* استایل‌های قبلی شما */
        body {
            font-family: Arial, sans-serif;
            background: #f0f0f0;
            margin: 0;
            padding: 0;
            direction: rtl;
        }
        .container {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            width: 90%;
            max-width: 800px;
            margin: 0 auto;
            margin-top: 20px;
        }
        h1 {
            text-align: center;
            margin-bottom: 20px;
        }
        .form-container {
            background: #fff;
            padding: 15px;
            border-bottom: 2px solid #ddd;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
        }
        input, button {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
            margin-bottom: 10px;
        }
        button {
            background: #007bff;
            color: #fff;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        .notification {
            padding: 10px;
            background: #ff0000;
            color: #fff;
            border-radius: 5px;
            text-align: center;
            margin-bottom: 10px;
            cursor: pointer;
        }
        .notification:hover {
            background: #cc0000;
        }
        .school, .student {
            margin-bottom: 20px;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            position: relative;
            background: #fff; /* ثابت ماندن رنگ پس‌زمینه */
        }
        .school h2 {
            margin: 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #007bff;
        }
        .student {
            margin-top: 10px;
            border-width: 2px; /* ضخامت حاشیه */
            border-style: solid; /* نوع حاشیه */
        }
        .student h3 {
            margin: 0;
            color: #007bff;
            cursor: pointer;
            text-decoration: underline;
        }
        .total-stickers {
            font-weight: bold;
            margin-bottom: 10px;
            display: inline-block;
        }
        .student-link {
            color: #007bff;
            cursor: pointer;
            text-decoration: underline;
        }
        .student-link:hover {
            color: #0056b3;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal-content {
            background-color: #fff;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 90%;
            max-width: 500px;
            border-radius: 10px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: #000;
        }
        #totalStickersAllSchools {
            font-weight: bold;
            margin-top: 20px;
            display: inline-block;
        }
        #backup-restore {
            margin-top: 20px;
            text-align: center;
        }
        #backup-restore button {
            width: auto;
        }
        .delete-button, #delete-all-button {
            width: 3cm;
            height: 1cm;
            background-color: #cccccc;
            color: #000;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            position: absolute;
            top: 10px;
            left: 10px;
        }
        .delete-button:hover, #delete-all-button:hover {
            background-color: #b3b3b3;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="form-container">
            <h1>مدیریت استیکر هنرجویان</h1>
            <div class="form-group">
                <label for="schoolName">نام آموزشگاه:</label>
                <input type="text" id="schoolName" placeholder="نام آموزشگاه را وارد کنید">
            </div>
            <div class="form-group">
                <label for="studentName">نام هنرجو:</label>
                <input type="text" id="studentName" placeholder="نام هنرجو را وارد کنید">
            </div>
            <div class="form-group">
                <label for="stickersCount">تعداد استیکرهای دریافت شده:</label>
                <input type="number" id="stickersCount" placeholder="تعداد استیکرها را وارد کنید">
            </div>
            <button onclick="addSticker()">افزودن استیکر</button>
            <div id="notificationsContainer"></div>
            <div id="totalStickersAllSchools">تعداد کل استیکرهای دریافت شده توسط همه‌ی آموزشگاه‌ها:</div>
            <button id="delete-all-button" onclick="confirmDeleteAll()">حذف همه‌ی اطلاعات</button>
        </div>
        <div id="schoolsContainer"></div>

        <!-- Backup and Restore Section -->
        <div id="backup-restore">
            <button onclick="backupData()">پشتیبان‌گیری</button>
            <input type="file" id="restoreFile" />
            <button onclick="restoreData()">بازگردانی</button>
        </div>
    </div>

    <!-- پنجره پاپ‌آپ (Modal) -->
    <div id="studentModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h1 id="modalStudentName"></h1>
            <div class="form-group">
                <label>استیکرهای این جلسه:</label>
                <input type="number" id="modalSessionStickers">
            </div>
            <div class="form-group">
                <label>مجموع استیکرها:</label>
                <input type="number" id="modalTotalStickers" readonly>
            </div>
            <button onclick="updateStickers()">بروزرسانی استیکرها</button>
        </div>
    </div>

    <script>
        let schools = {};
        let currentSchoolName = '';
        let currentStudentName = '';
        let notifications = [];
        let colors = {}; // Object to store colors for students

        function addSticker() {
            const schoolName = document.getElementById('schoolName').value;
            const studentName = document.getElementById('studentName').value;
            const stickersCount = parseInt(document.getElementById('stickersCount').value);
    
            if (!schoolName || !studentName || !stickersCount) {
                alert('لطفاً تمامی فیلدها را پر کنید');
                return;
            }

            if (!schools[schoolName]) {
                schools[schoolName] = {
                    totalStickers: 0,
                    students: {}
                };
            }

            if (!schools[schoolName].students[studentName]) {
                schools[schoolName].students[studentName] = {
                    sessionStickers: 0,
                    totalStickers: 0
                };
            }

            let student = schools[schoolName].students[studentName];
            student.sessionStickers += stickersCount;
            student.totalStickers += stickersCount;
            schools[schoolName].totalStickers += stickersCount;

            if (student.sessionStickers >= 10) {
                notifications.push({
                    schoolName: schoolName,
                    studentName: studentName
                });
                student.sessionStickers = 0; // Reset the session stickers
            }

            updateDisplay();
            saveData();
        }

        function updateDisplay() {
            const container = document.getElementById('schoolsContainer');
            container.innerHTML = '';

            let totalStickersAllSchools = 0;

            for (const schoolName in schools) {
                const schoolDiv = document.createElement('div');
                schoolDiv.className = 'school';
                schoolDiv.style.borderColor = '#007bff'; // Fixed color for schools
                schoolDiv.innerHTML = `
                    <h2>${schoolName}</h2>
                    <p class="total-stickers">مجموع استیکرها: ${schools[schoolName].totalStickers}</p>
                    <button class="delete-button" onclick="deleteSchool('${schoolName}')">حذف آموزشگاه</button>
                `;

                for (const studentName in schools[schoolName].students) {
                    const student = schools[schoolName].students[studentName];
                    const studentDiv = document.createElement('div');
                    studentDiv.className = 'student';

                    // Assign a color for each student if not already assigned
                    if (!colors[studentName]) {
                        colors[studentName] = getRandomColor();
                    }
                    studentDiv.style.borderColor = colors[studentName]; // Use stored color for student
                    studentDiv.innerHTML = `
                        <h3><span class="student-link" onclick="openModal('${schoolName}', '${studentName}')">${studentName}</span></h3>
                        <p>تعداد استیکرهای این جلسه: ${student.sessionStickers}</p>
                        <p>مجموع استیکرها: ${student.totalStickers}</p>
                        <button class="delete-button" onclick="deleteStudent('${schoolName}', '${studentName}')">حذف هنرجو</button>
                    `;

                    schoolDiv.appendChild(studentDiv);
                }

                container.appendChild(schoolDiv);
                totalStickersAllSchools += schools[schoolName].totalStickers;
            }

            const totalStickersElement = document.getElementById('totalStickersAllSchools');
            totalStickersElement.innerText = `تعداد کل استیکرهای دریافت شده توسط همه‌ی آموزشگاه‌ها: ${totalStickersAllSchools}`;

            updateNotifications();
        }

        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        function updateNotifications() {
            const notificationsContainer = document.getElementById('notificationsContainer');
            notificationsContainer.innerHTML = '';
        
            notifications.forEach((notification, index) => {
                const notificationDiv = document.createElement('div');
                notificationDiv.className = 'notification';
                notificationDiv.innerText = `هنرجو ${notification.studentName} از آموزشگاه ${notification.schoolName} باید جایزه دریافت کند.`;
                notificationDiv.onclick = () => removeNotification(index);
                notificationsContainer.appendChild(notificationDiv);
            });
        }

        function removeNotification(index) {
            notifications.splice(index, 1);
            updateNotifications();
            saveData();
        }

        function openModal(schoolName, studentName) {
            currentSchoolName = schoolName;
            currentStudentName = studentName;
            let student = schools[schoolName].students[studentName];

            document.getElementById('modalStudentName').innerText = studentName;
            document.getElementById('modalSessionStickers').value = student.sessionStickers;
            document.getElementById('modalTotalStickers').value = student.totalStickers;

            document.getElementById('studentModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('studentModal').style.display = 'none';
        }

        function updateStickers() {
            const newSessionStickers = parseInt(document.getElementById('modalSessionStickers').value);
            let student = schools[currentSchoolName].students[currentStudentName];

            let oldSessionStickers = student.sessionStickers;
            student.totalStickers += (newSessionStickers - oldSessionStickers);
            student.sessionStickers = newSessionStickers;

            schools[currentSchoolName].totalStickers += (newSessionStickers - oldSessionStickers);

            if (student.sessionStickers >= 10) {
                notifications.push({
                    schoolName: currentSchoolName,
                    studentName: currentStudentName
                });
                student.sessionStickers = 0; // Reset session stickers after reaching 10
            }

            closeModal();
            updateDisplay();
            saveData();
        }

        function saveData() {
            localStorage.setItem('schools', JSON.stringify(schools));
            localStorage.setItem('notifications', JSON.stringify(notifications));
            localStorage.setItem('colors', JSON.stringify(colors));
        }

        function loadData() {
            const savedSchools = localStorage.getItem('schools');
            const savedNotifications = localStorage.getItem('notifications');
            const savedColors = localStorage.getItem('colors');
            if (savedSchools) {
                schools = JSON.parse(savedSchools);
            }
            if (savedNotifications) {
                notifications = JSON.parse(savedNotifications);
            }
            if (savedColors) {
                colors = JSON.parse(savedColors);
            }
            updateDisplay();
        }

        function handleURLParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            const schoolName = urlParams.get('school');
            const studentName = urlParams.get('student');
            if (schoolName && studentName) {
                currentSchoolName = schoolName;
                currentStudentName = studentName;
                openModal(schoolName, studentName);
            }
        }

        function backupData() {
            const data = {
                schools,
                notifications,
                colors
            };
            const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'backup.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function restoreData() {
            const fileInput = document.getElementById('restoreFile');
            if (fileInput.files.length === 0) {
                alert('لطفاً یک فایل انتخاب کنید');
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = JSON.parse(e.target.result);
                schools = data.schools || {};
                notifications = data.notifications || [];
                colors = data.colors || {};
                updateDisplay();
                saveData();
            };
            reader.readAsText(file);
        }

        function deleteStudent(schoolName, studentName) {
            if (confirm('آیا از حذف هنرجو مطمئن هستید؟')) {
                const student = schools[schoolName].students[studentName];
                schools[schoolName].totalStickers -= student.totalStickers;
                delete schools[schoolName].students[studentName];
                updateDisplay();
                saveData();
            }
        }

        function deleteSchool(schoolName) {
            if (confirm('آیا از حذف آموزشگاه مطمئن هستید؟')) {
                const totalStickers = schools[schoolName].totalStickers;
                delete schools[schoolName];
                notifications = notifications.filter(notification => notification.schoolName !== schoolName);
                updateDisplay();
                saveData();
            }
        }

        function deleteAllData() {
            if (confirm('آیا از حذف تمامی اطلاعات مطمئن هستید؟')) {
                const confirmation = prompt('برای تایید، کلمه "حذف" را تایپ کنید:');
                if (confirmation ==='حذف') {
                    schools = {};
                    notifications = [];
                    colors = {};
                    updateDisplay();
                    saveData();
                }
            }
        }

        window.onload = function() {
            loadData();
            handleURLParameters();
        };
    </script>
</body>
</html>